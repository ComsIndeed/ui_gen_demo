name: Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - 'pubspec.yaml'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if version unchanged'
        required: false
        default: true
        type: boolean

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      new_version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version changed
        id: check
        run: |
          # Get current version (strip any build number after +)
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//' | tr -d '[:space:]')
          echo "Current version: $CURRENT_VERSION"
          
          # Check if manual trigger with force build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_build }}" == "true" ]; then
            echo "Manual trigger with force build enabled"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if there's a previous commit
          if git rev-parse HEAD^1 >/dev/null 2>&1; then
            # Get previous version
            PREVIOUS_VERSION=$(git show HEAD^1:pubspec.yaml | grep '^version:' | sed 's/version: //' | sed 's/+.*//' | tr -d '[:space:]')
            echo "Previous version: $PREVIOUS_VERSION"
          else
            # First commit, no previous version
            PREVIOUS_VERSION=""
            echo "No previous commit found (first commit)"
          fi
          
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged"
          fi

  build-android:
    needs: check-version-change
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  build-windows:
    needs: check-version-change
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows Archive
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath build\windows\ui_gen_demo-windows.zip

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: build\windows\ui_gen_demo-windows.zip

  build-web:
    needs: check-version-change
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href /${{ github.event.repository.name }}/

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-release
          path: build/web/

  deploy-github-pages:
    needs: [check-version-change, build-web]
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-release
          path: build/web

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          publish_branch: gh-pages
          force_orphan: true

  create-release:
    needs: [check-version-change, build-android, build-windows, build-web, deploy-github-pages]
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/

      - name: Download Windows Build
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: artifacts/

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-release
          path: artifacts/web/

      - name: Rename and prepare artifacts
        run: |
          VERSION="${{ needs.check-version-change.outputs.new_version }}"
          mv artifacts/app-release.apk artifacts/ui_gen_demo-v$VERSION-android.apk
          mv artifacts/ui_gen_demo-windows.zip artifacts/ui_gen_demo-v$VERSION-windows.zip
          cd artifacts && zip -r ui_gen_demo-v$VERSION-web.zip web/ && rm -rf web/

      - name: Generate checksums
        run: |
          VERSION="${{ needs.check-version-change.outputs.new_version }}"
          cd artifacts
          sha256sum ui_gen_demo-v$VERSION-android.apk > ui_gen_demo-v$VERSION-android.apk.sha256
          sha256sum ui_gen_demo-v$VERSION-windows.zip > ui_gen_demo-v$VERSION-windows.zip.sha256
          sha256sum ui_gen_demo-v$VERSION-web.zip > ui_gen_demo-v$VERSION-web.zip.sha256
          
          # Create combined checksums file
          cat *.sha256 > CHECKSUMS.txt
          echo "Generated checksums:"
          cat CHECKSUMS.txt

      - name: Extract changelog (optional)
        id: changelog
        run: |
          VERSION="${{ needs.check-version-change.outputs.new_version }}"
          CHANGELOG=""
          
          # Check if CHANGELOG.yaml exists and try to extract changes
          if [ -f "CHANGELOG.yaml" ]; then
            # Install yq
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
            
            # Try to extract changelog, ignore errors
            CHANGELOG=$(yq eval ".versions[] | select(.version == \"$VERSION\") | .changes | .[]" CHANGELOG.yaml 2>/dev/null | sed 's/^/- /' || echo "")
          fi
          
          # Create release notes
          if [ -n "$CHANGELOG" ]; then
            cat > release_notes.md << EOF
          ## What's New
          $CHANGELOG

          EOF
          else
            cat > release_notes.md << EOF
          ## What's New
          - Version $VERSION release

          EOF
          fi
          
          # Add download info and checksums
          cat >> release_notes.md << EOF
          ## Downloads
          | Platform | File | Description |
          |----------|------|-------------|
          | Android | \`ui_gen_demo-v$VERSION-android.apk\` | Direct install APK |
          | Windows | \`ui_gen_demo-v$VERSION-windows.zip\` | Portable Windows app (extract and run) |
          | Web | \`ui_gen_demo-v$VERSION-web.zip\` | Web build archive |

          ## Live Web App
          ðŸŒ **Try it now**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

          ## Checksums (SHA256)
          Verify your download integrity with these checksums:
          \`\`\`
          $(cat artifacts/CHECKSUMS.txt)
          \`\`\`

          ## How to Verify
          - **Linux/macOS**: \`sha256sum -c <filename>.sha256\`
          - **Windows PowerShell**: \`Get-FileHash <filename> -Algorithm SHA256\`
          EOF
          
          echo "Release notes created:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version-change.outputs.new_version }}
          name: Release v${{ needs.check-version-change.outputs.new_version }}
          body_path: release_notes.md
          files: |
            artifacts/ui_gen_demo-v${{ needs.check-version-change.outputs.new_version }}-android.apk
            artifacts/ui_gen_demo-v${{ needs.check-version-change.outputs.new_version }}-android.apk.sha256
            artifacts/ui_gen_demo-v${{ needs.check-version-change.outputs.new_version }}-windows.zip
            artifacts/ui_gen_demo-v${{ needs.check-version-change.outputs.new_version }}-windows.zip.sha256
            artifacts/ui_gen_demo-v${{ needs.check-version-change.outputs.new_version }}-web.zip
            artifacts/ui_gen_demo-v${{ needs.check-version-change.outputs.new_version }}-web.zip.sha256
            artifacts/CHECKSUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
